<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bowling Toolkit (Private)</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f141a; --border:#1f2a37;
      --text:#e6edf3; --muted:#9aa4b2; --btn:#121a24; --btnOn:#1a2635;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:12px;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:12px}

    .top{
      background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
      padding:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
    }
    .left,.right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    button{
      appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--text);
      border-radius:14px;padding:14px 16px;min-height:48px;min-width:140px;
      font-size:clamp(14px,2.2vw,18px);line-height:1;touch-action:manipulation;
    }
    button.on{background:var(--btnOn)}
    button.icon{min-width:56px;padding:14px 0;text-align:center}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55}

    .pill{
      border:1px solid var(--border);border-radius:999px;padding:10px 12px;min-height:48px;
      display:flex;align-items:center;color:var(--muted);font-size:clamp(12px,2vw,15px);
    }

    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
      padding:12px;
    }

    .modeGrid{
      display:grid;gap:12px;
      grid-template-columns:repeat(3, minmax(0,1fr));
    }
    @media (max-width:860px){ .modeGrid{grid-template-columns:1fr} }

    .modeBtn{
      width:100%;min-height:90px;
      display:flex;flex-direction:column;align-items:flex-start;justify-content:center;
      gap:6px;padding:16px;
    }
    .modeBtn .t{font-size:20px;color:var(--text)}
    .modeBtn .s{font-size:14px;color:var(--muted)}

    .hide{display:none !important}

    /* Camera stage */
    .stage{
      background:#000;border:1px solid var(--border);border-radius:var(--radius);
      overflow:hidden;position:relative;
    }
    canvas{width:100%;height:auto;display:block;background:#000}
    video{display:none}

    /* Controls rows */
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    label{color:var(--muted);font-size:14px}
    input[type="range"]{width:min(520px,78vw)}
    select{
      background:var(--btn);color:var(--text);border:1px solid var(--border);
      border-radius:12px;padding:12px;min-height:44px;font-size:14px;
    }
    input[type="text"], input[type="number"]{
      background:var(--btn);color:var(--text);border:1px solid var(--border);
      border-radius:12px;padding:12px;min-height:44px;font-size:14px;
      width:min(520px,78vw);
    }

    /* Patterns list */
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--border);border-radius:14px;padding:12px;
      display:flex;flex-direction:column;gap:6px;
      background:rgba(255,255,255,0.02);
    }
    .item .name{font-size:16px;color:var(--text)}
    .item .meta{font-size:13px;color:var(--muted)}
    .item a{color:var(--text);text-decoration:none}
    .item a:hover{text-decoration:underline}

    .big{
      font-size:clamp(28px,5vw,44px);
      letter-spacing:-0.02em;
    }
    .sub{
      color:var(--muted);
      font-size:16px;
    }
    .center{display:flex;flex-direction:column;gap:10px;align-items:flex-start}
  </style>
</head>
<body>
<div class="wrap">

  <div class="top">
    <div class="left">
      <button id="homeBtn" class="icon" aria-label="Home">⌂</button>
      <div class="pill" id="titlePill">Home</div>
    </div>
    <div class="right">
      <div class="pill" id="status">Bereit</div>
    </div>
  </div>

  <!-- HOME -->
  <div id="home" class="card">
    <div class="modeGrid">
      <button class="modeBtn" id="goCam">
        <div class="t">Kamera</div>
        <div class="s">Delay / Qualität</div>
      </button>
      <button class="modeBtn" id="goSpeed">
        <div class="t">Speed</div>
        <div class="s">Stopuhr → km/h</div>
      </button>
      <button class="modeBtn" id="goPatterns">
        <div class="t">Ölpattern</div>
        <div class="s">Suche / Links</div>
      </button>
    </div>
  </div>

  <!-- CAMERA -->
  <div id="cam" class="hide">
    <div class="card">
      <div class="row">
        <button id="startCam">Start</button>
        <button id="freezeCam">Freeze</button>
        <button id="switchCam">Kamera wechseln</button>
        <button id="fsCam">Vollbild</button>
      </div>
    </div>

    <div class="stage" id="stage">
      <canvas id="out"></canvas>
      <video id="live" playsinline autoplay muted></video>
    </div>

    <div class="card">
      <div class="row">
        <label for="delay">Delay</label>
        <div class="pill"><b><span id="dLabel">10</span>s</b></div>
      </div>
      <div class="row">
        <input id="delay" type="range" min="1" max="30" value="10" />
      </div>

      <div class="row">
        <label for="quality">Qualität</label>
        <select id="quality">
          <option value="0">Medium (720p)</option>
          <option value="1" selected>Hoch (1080p)</option>
          <option value="2">Ultra (1440p)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- SPEED -->
  <div id="speed" class="hide">
    <div class="card">
      <div class="center">
        <div class="big" id="timeBig">0.000 s</div>
        <div class="sub" id="speedBig">0.0 km/h</div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnRelease">Release</button>
        <button id="btnStop">Stop</button>
        <button id="btnReset">Reset</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <label for="distFt">Distanz</label>
        <input id="distFt" type="number" step="0.1" min="1" value="60" />
      </div>
      <div class="row">
        <div class="pill">Formel: Geschwindigkeit = Distanz / Zeit</div>
        <div class="pill" id="mphPill">0.0 mph</div>
      </div>
    </div>
  </div>

  <!-- PATTERNS -->
  <div id="patterns" class="hide">
    <div class="card">
      <div class="row">
        <label for="search">Suche</label>
        <input id="search" type="text" placeholder="kegel / brunswick / pba / world bowling ..." />
      </div>
    </div>

    <div class="card">
      <div class="list" id="list"></div>
    </div>
  </div>

</div>

<script>
  // ---------- Simple navigation ----------
  const home = document.getElementById('home');
  const cam = document.getElementById('cam');
  const speed = document.getElementById('speed');
  const patterns = document.getElementById('patterns');

  const titlePill = document.getElementById('titlePill');
  const statusEl = document.getElementById('status');

  function setStatus(t){ statusEl.textContent = t; }
  function show(view){
    home.classList.add('hide');
    cam.classList.add('hide');
    speed.classList.add('hide');
    patterns.classList.add('hide');
    view.classList.remove('hide');
  }
  function setTitle(t){ titlePill.textContent = t; }

  document.getElementById('homeBtn').onclick = ()=>{ setTitle("Home"); setStatus("Bereit"); show(home); };

  document.getElementById('goCam').onclick = ()=>{ setTitle("Kamera"); show(cam); };
  document.getElementById('goSpeed').onclick = ()=>{ setTitle("Speed"); show(speed); };
  document.getElementById('goPatterns').onclick = ()=>{ setTitle("Ölpattern"); show(patterns); };

  // ---------- CAMERA (delay) ----------
  const live = document.getElementById('live');
  const out  = document.getElementById('out');
  const ctx  = out.getContext('2d', { alpha:false });
  const stage = document.getElementById('stage');

  const startCamBtn = document.getElementById('startCam');
  const freezeCamBtn = document.getElementById('freezeCam');
  const switchCamBtn = document.getElementById('switchCam');
  const fsCamBtn = document.getElementById('fsCam');

  const delaySlider = document.getElementById('delay');
  const dLabel = document.getElementById('dLabel');
  const qualitySelect = document.getElementById('quality');

  let stream=null, running=false, frozen=false, facing="environment", captureTimer=null;

  // Frame buffer using ImageData (very compatible)
  let frames=[]; // {t:number, img:ImageData}
  const captureCanvas=document.createElement('canvas');
  const captureCtx=captureCanvas.getContext('2d', { willReadFrequently:true });

  const presets=[
    {name:"Medium", w:1280, h:720,  fps:24 },
    {name:"Hoch",   w:1920, h:1080, fps:30 },
    {name:"Ultra",  w:2560, h:1440, fps:30 }
  ];
  function preset(){ return presets[Number(qualitySelect.value)]; }
  function clearFrames(){ frames.length=0; }

  dLabel.textContent = delaySlider.value;
  delaySlider.oninput = ()=>{ dLabel.textContent = delaySlider.value; };

  function pickFrameAtOrBefore(targetTime){
    if(!frames.length) return null;
    let lo=0, hi=frames.length-1, best=0;
    while(lo<=hi){
      const mid=(lo+hi)>>1;
      if(frames[mid].t<=targetTime){ best=mid; lo=mid+1; }
      else hi=mid-1;
    }
    return frames[best];
  }

  async function stopCam(){
    running=false; frozen=false;
    freezeCamBtn.classList.remove('on');
    freezeCamBtn.textContent="Freeze";
    if(captureTimer){ clearInterval(captureTimer); captureTimer=null; }
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    clearFrames();
    setStatus("Bereit");
  }

  async function waitForPlaying(video, timeoutMs=6000){
    const start=performance.now();
    while(video.readyState < 2 || video.paused){
      try{ await video.play(); }catch(e){}
      await new Promise(r=>setTimeout(r, 80));
      if(performance.now()-start > timeoutMs) break;
    }
  }

  async function startCam(){
    const p=preset();
    setStatus("Start…");

    stream = await navigator.mediaDevices.getUserMedia({
      audio:false,
      video:{
        facingMode:{ ideal:facing },
        width:{ ideal:p.w }, height:{ ideal:p.h },
        frameRate:{ ideal:p.fps, max:p.fps }
      }
    });

    live.srcObject = stream;
    live.muted = true;
    live.playsInline = true;

    await new Promise(r=>live.onloadedmetadata=r);
    await waitForPlaying(live, 6000);

    const vw = live.videoWidth || p.w;
    const vh = live.videoHeight || p.h;

    out.width = vw;
    out.height = vh;

    captureCanvas.width = vw;
    captureCanvas.height = vh;

    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";

    running=true; frozen=false;
    clearFrames();
    setStatus("Läuft");

    const interval=Math.max(20, Math.round(1000/p.fps));

    captureTimer=setInterval(()=>{
      if(!running) return;
      try{
        captureCtx.drawImage(live, 0, 0, vw, vh);
        const img = captureCtx.getImageData(0,0,vw,vh);
        frames.push({ t: Date.now(), img });

        const delaySec=Number(delaySlider.value);
        const maxFrames=Math.ceil((delaySec+2)*p.fps);
        while(frames.length>maxFrames) frames.shift();
      }catch(e){
        setStatus("Kamera-Frame Fehler");
      }
    }, interval);

    function drawLoop(){
      if(!running) return;

      if(!frozen){
        const delaySec=Number(delaySlider.value);
        const targetTime=Date.now() - delaySec*1000;
        const f = pickFrameAtOrBefore(targetTime);

        if(f){
          // Draw ImageData quickly via putImageData
          ctx.putImageData(f.img, 0, 0);
        }else{
          // buffer not filled yet
          try{ ctx.drawImage(live, 0,0,out.width,out.height); }catch(e){}
        }
      }
      requestAnimationFrame(drawLoop);
    }
    requestAnimationFrame(drawLoop);
  }

  startCamBtn.onclick = async()=>{
    if(running) return;
    try{ await startCam(); }
    catch(e){ console.error(e); setStatus("Kamera blockiert"); }
  };

  freezeCamBtn.onclick = ()=>{
    frozen = !frozen;
    freezeCamBtn.classList.toggle('on', frozen);
    freezeCamBtn.textContent = frozen ? "Weiter" : "Freeze";
    setStatus(frozen ? "Freeze" : (running ? "Läuft" : "Bereit"));
  };

  switchCamBtn.onclick = async()=>{
    facing = (facing==="environment") ? "user" : "environment";
    if(running){ await stopCam(); await startCam(); }
  };

  fsCamBtn.onclick = async()=>{
    try{
      if(!document.fullscreenElement) await stage.requestFullscreen();
      else await document.exitFullscreen();
    }catch(e){ setStatus("Vollbild nicht verfügbar"); }
  };

  window.addEventListener("pagehide", ()=>stopCam());

  // ---------- SPEED TIMER ----------
  const timeBig = document.getElementById('timeBig');
  const speedBig = document.getElementById('speedBig');
  const mphPill = document.getElementById('mphPill');

  const btnRelease = document.getElementById('btnRelease');
  const btnStop = document.getElementById('btnStop');
  const btnReset = document.getElementById('btnReset');
  const distFt = document.getElementById('distFt');

  let t0 = null;
  let rafId = null;
  let lastElapsed = 0;

  function ftToMeters(ft){ return ft * 0.3048; }
  function kmhFrom(ft, sec){
    const m = ftToMeters(ft);
    const mps = m / sec;
    return mps * 3.6;
  }
  function mphFrom(kmh){ return kmh * 0.621371; }

  function renderTime(sec){
    timeBig.textContent = `${sec.toFixed(3)} s`;
    const ft = Math.max(1, Number(distFt.value || 60));
    const kmh = (sec>0) ? kmhFrom(ft, sec) : 0;
    speedBig.textContent = `${kmh.toFixed(1)} km/h`;
    mphPill.textContent = `${mphFrom(kmh).toFixed(1)} mph`;
  }

  function tick(){
    if(t0 === null) return;
    const now = performance.now();
    lastElapsed = (now - t0) / 1000;
    renderTime(lastElapsed);
    rafId = requestAnimationFrame(tick);
  }

  btnRelease.onclick = ()=>{
    t0 = performance.now();
    lastElapsed = 0;
    if(rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(tick);
    setStatus("Speed läuft");
  };

  btnStop.onclick = ()=>{
    if(t0 === null) return;
    if(rafId) cancelAnimationFrame(rafId);
    rafId = null;
    const now = performance.now();
    lastElapsed = (now - t0) / 1000;
    t0 = null;
    renderTime(lastElapsed);
    setStatus("Speed gestoppt");
  };

  btnReset.onclick = ()=>{
    if(rafId) cancelAnimationFrame(rafId);
    rafId = null;
    t0 = null;
    lastElapsed = 0;
    renderTime(0);
    setStatus("Bereit");
  };

  distFt.oninput = ()=>{ renderTime(lastElapsed); };

  // ---------- PATTERNS (links + search) ----------
  const search = document.getElementById('search');
  const list = document.getElementById('list');

  const PATTERNS = [
    {
      name: "Kegel – Pattern Library",
      meta: "Offizielle Kegel-Datenbank",
      url: "https://patternlibrary.kegel.net/"
    },
    {
      name: "Kegel – Pattern Library (Info)",
      meta: "Kegel-Seite zur Library",
      url: "https://www.kegel.net/pattern-library-app"
    },
    {
      name: "Brunswick – Pattern Library",
      meta: "Brunswick Library/Tools",
      url: "https://brunswickbowling.com/bowling-centers/equipment-parts-supplies/center-maintenance/lane-machines/pattern-library"
    },
    {
      name: "PBA – Oil Patterns",
      meta: "Offizielle PBA Pattern-Seite",
      url: "https://www.pba.com/player-resources/oil-patterns"
    },
    {
      name: "World Bowling – Previously Used Lane Patterns",
      meta: "Liste mit vielen Pattern-Dateien/Downloads",
      url: "https://bowling.sport/resources-2/lane-patterns-2/lane-patterns/"
    }
  ];

  function renderList(q){
    const query = (q||"").trim().toLowerCase();
    list.innerHTML = "";
    for(const p of PATTERNS){
      const hay = (p.name + " " + p.meta).toLowerCase();
      if(query && !hay.includes(query)) continue;

      const div = document.createElement('div');
      div.className = "item";
      div.innerHTML = `
        <div class="name"><a href="${p.url}" target="_blank" rel="noopener noreferrer">${p.name}</a></div>
        <div class="meta">${p.meta}</div>
      `;
      list.appendChild(div);
    }
  }

  search.oninput = ()=>renderList(search.value);
  renderList("");

  // Init
  renderTime(0);
  setTitle("Home");
  setStatus("Bereit");
  show(home);
</script>
</body>
</html>
